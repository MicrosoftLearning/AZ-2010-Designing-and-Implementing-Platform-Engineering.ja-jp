---
lab:
  title: Azure Monitor を使用したリアルタイム監視の実装
  module: Observability and Continuous Improvement
---

# ラボ 02: Azure Monitor を使用したリアルタイム監視の実装

## 推定時間:20 分

## 前提条件

- Azure サブスクリプション - Azure サブスクリプションをお持ちでない場合は、[無料アカウント](https://azure.microsoft.com/free/)を作成してください。
- 監視と可観測性の概念に関する基本的な知識。
- Azure のサービスについての基本的な理解。

## 目標

- サンプル Web アプリケーションを作成します。
- Azure Monitor と Application Insights を有効にして構成します。
- カスタム ダッシュボードを作成して、アプリケーション メトリックを視覚化します。
- パフォーマンスの異常を関係者に通知するアラートを設定します。
- パフォーマンス データを分析して、潜在的な改善を実現します。

## 演習 1: サンプル Web アプリケーションを作成する

プラットフォーム エンジニアは、プラットフォームで実行されているアプリケーションが観測可能で継続的に監視されるようにする必要があります。 このラボでは、Azure へのサンプル Web アプリケーションの作成、Azure Monitor と Application Insights の構成、カスタム ダッシュボードの設定、アプリケーションのパフォーマンスを追跡するためのアラートの作成を行います。

### タスク 1:Azure Web アプリを作成する

1. Azure Portalを開きます。
1. 検索バーに「App Service」と入力し、それを選択します。
1. [+ 作成] をクリックして、Web アプリを選択します。
1. [基本] タブで、次の操作を行います。
   - サブスクリプション:Azure サブスクリプションを選択します。
   - リソース グループ: [新規作成] をクリックし、「**`monitoringlab-rg`**」と入力して、[OK] をクリックします。
   - 名前: 一意な名前を入力します (例: **`monitoringlab-webapp`**)。
   - 発行: [コード] を選択します。
   - ランタイム スタック: [.NET 8 (LTS)] を選択します。
   - リージョン: 近くのリージョンを選択します。
1. [確認および作成] をクリックして、[作成] をクリックします。
1. デプロイが完了するまで待ってから、[リソースに移動] をクリックします。
1. [概要] タブで、URL をクリックして Web アプリが実行されていることを確認します。

### タスク 2: Application Insights を確認する

1. Web アプリのリソースで、[監視] セクションまでスクロールします。
1. [Application Insights] をクリックします。
1. Application Insights は、この Web アプリに対して既に有効になっています。 リンクをクリックして、Application Insights のリソースを開きます。
1. Application Insights のリソースで、アプリケーション ダッシュボード内をクリックして、提供される既定のダッシュボードのパフォーマンス データを表示します。

## 演習 2: Azure Monitor とダッシュボードを構成する

### タスク 1: Azure Monitor にアクセスする

1. Azure Portal で、[監視] を検索してクリックします。
1. 左側のパネルで [メトリック] をクリックします。
1. [スコープ] セクションで、Web アプリをデプロイしたサブスクリプションとリソース グループの下にある Web アプリを選択します。
1. [適用] をクリックし、Web アプリで使用できるメトリックを確認します。

### タスク 2: ダッシュボードに主要なメトリックを追加する

1. [スコープ] セクションで、Web アプリ (monitoringlab-webapp) を選択します。
1. [メトリック] で、[応答時間] を選択します。
1. [集計] を [平均] に設定し、[+ メトリックの追加] をクリックします。
1. 追加のメトリックがあれば、この手順を繰り返します。
   - CPU 時間 (カウント)
   - リクエスト (平均)
1. ダッシュボードをクリックし、ダッシュボードにピン留めします。
1. 種類 [Shared] を選択し、サブスクリプションと monitoringlab-webapp ダッシュボードを選択します。
1. [ダッシュボードにピン留め] をクリックします。
1. 左側のパネルのダッシュボード アイコンをクリックして、ダッシュボードを表示します。
1. メトリックがダッシュボードに表示され、リアルタイムで更新されていることを確認します。

## 演習 3: アラートを作成する

### タスク 1: アラートの条件とアクションを定義する

1. Azure Monitor で、[アラート] をクリックします。
1. [+ 作成] をクリックし、[アラート ルール] を選択します。
1. [スコープ] で、Web アプリ (monitoringlab-webapp) を選択し、[適用] をクリックします。
1. [条件] の "シグナル名" フィールドをクリックし、[応答時間] を選択します。
1. アラート ルールを次のように構成します。
   - しきい値の種類: 動的
   - 集計の種類: 平均
   - 値: 次の値より大きいまたは小さい
   - しきい値の感度: 高
   - 評価の頻度: 1 分ごとに確認し、ルックバックは 5 分。
1. [アクション] で、[クイック アクションを使用する] を選択します。
1. 次を入力します。
   - アクション グループ名: WebAppMonitoringAlerts
   - 表示名: WebAlert
   - 電子メール: 自分のメール アドレスを入力します。
1. [保存] をクリックします。
1. [次へ: 詳細] をクリックします。
1. 名前「`WebAppResponseTimeAlert`」を入力し、重大度レベル [詳細] を選択します。
1. [確認と作成]、[作成] の順にクリックします。

   > **注:** これでアラート ルールが作成され、応答時間がしきい値を超えると電子メールによる通知がトリガーされます。 Web アプリに大量の要求を送信することで、アラートを強制的にトリガーできます。 たとえば、Azure Load Testing や、Apache JMeter などのツールを使用できます。

1. [Azure Monitor] - [アラート] に戻ります。
1. [アラート ルール] をクリックすると、作成したアラート ルールが表示されるはずです。

## 演習 4: パフォーマンス データを分析する

### タスク 1: 収集されたメトリックを確認する

1. Azure portal 内で、 [Application Insights] に移動します。
1. [アプリケーション ダッシュボード] をクリックします。
1. [パフォーマンス] タイルをクリックして、サーバーの応答時間と負荷を分析します。 要求の数と失敗した要求の数を表示することもできます。
1. [Workbooks で分析] をクリックし、[パフォーマンス カウンター分析] を選択します。
1. [Workbooks] をクリックします。
1. [パフォーマンス] で [Workbook パフォーマンス分析] を選択します。
1. Web アプリのパフォーマンス データを確認できます。

> **注:** Workbook をカスタマイズして、追加のメトリックとフィルターを含めることができます。
